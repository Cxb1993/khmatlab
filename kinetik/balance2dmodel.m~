function [c, segms] = balance2dmodel(varargin)
%  [c, segms] = balance2dmodel(ang1, ang2, ..., mod2d, jointc)
% Returns the squared horizontal distance from the total center of
% mass of the 2d model to the distal end of the distal most
% segment. 
%
% Input
%    angx       ->  The joint angles, corresponding to similar
%                   elements in mod2d and jointc
%    mod2d      ->  Cell array with 2d models. Distal segments
%                   first.
%    jointc     ->  matrix with joint centers [ankle knee hip]. 
%                   The positions are given in homogenous
%                   coordinates, where the last element can be 
%                   1 or -1 indicating that the rotation axis
%                   comes out of or goes into the plane of the 2d
%                   movement.
% Output
%    segms      ->  Cell array, where each cell
%                   contains a segment struct:
%                   mass   ->  The mass of the segment
%                   CoM    ->  Current position of CoM
%                   prox   ->  Current position of proximal joint
%                   dist   ->  Current position of distal joint

% Kjartan Halvorsen
% 2004-10-05
  
mod2d = varargin{end-1};
jointc = varargin{end};

segms = cell(size(mod2d));

R = eye(2);
prox = [0;0];

% assume segments organized as a vertical chain. Distal tip of
% distal segment at origin.

for s=1:length(mod2d)
  segm.dist = prox;
  
  cs = cos(varargin{s});
  sn = sin(varargin{s});
  sgn = sign(jointc(s,3);
  Rs = [cs -sgn*sn; sgn*sn cs];
  R=R*Rs;
  
  segm.CoM = segm.dist + R*[0; mod2d{s}.length - mod2d{s}.CoM];
  p0(end) = 
  Gs = 